---
    # Clean dest directory
      - name: "Delete destination dir"
        file:
          state: absent
          path: '{{ homeDir }}/{{ appDir }}'

      - name: "Recreate empty direcoty"
        file:
          state: directory
          path: '{{ homeDir }}/{{ appDir }}'

      - name: "install unzip"
        shell: apt-get install unzip

      - name: Copy and unarchive artifact file
        unarchive:
          src: '{{ artifact_path }}_weightzippedApp.zip'
          dest: '{{ homeDir }}/{{ appDir }}'

      - name: "Template a file"
        template:
          src: './.env'
          dest: '{{ homeDir }}/{{ appDir }}'
          owner: '{{ user }}'
          mode: u=r,g=r,o=r

      - name: "Install nodemon"
        shell: npm install nodemon
        args:
          chdir: '{{ homeDir }}/{{ appDir }}'
        register: node_finished

      - name: "Init DB"
        shell: npm run initdb
        args:
          chdir: '{{ homeDir }}/{{ appDir }}'
        run_once: true
      
      - name: "Install PM2"
        npm:
          name: pm2
          global: yes
          state: present

      - name: Start APP
        shell: pm2 start npm -- run dev
        args: 
          chdir: '{{ homeDir }}/{{ appDir }}'
        register: start_finished

      - name: Save PM2 configuration
        shell: pm2 save
        args:
          chdir: '{{ homeDir }}/{{ appDir }}'
        when: start_finished.changed

      - name: Create PM2 startup script
        shell: pm2 startup
        args:
          chdir: '{{ homeDir }}/{{ appDir }}'